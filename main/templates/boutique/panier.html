{% extends "main/base.html" %}
{% load static %}
{% block content %}

<style>
  /* 🌌 Background avec dégradé animé */
  body {
    background: linear-gradient(135deg, #1d2671, #c33764);
    background-size: 400% 400%;
    animation: gradientBG 12s ease infinite;
    color: #fff;
  }

  @keyframes gradientBG {
    0% {background-position: 0% 50%;}
    50% {background-position: 100% 50%;}
    100% {background-position: 0% 50%;}
  }

  /* 📦 Carte centrale du panier */
  .panier-card {
    background: rgba(255, 255, 255, 0.08);
    backdrop-filter: blur(10px);
    border-radius: 16px;
    padding: 25px;
    box-shadow: 0 8px 25px rgba(0,0,0,0.3);
    transition: transform 0.3s ease;
  }
  .panier-card:hover {
    transform: translateY(-5px);
  }

  /* 🧾 Tableau stylisé */
  table {
    border-radius: 12px;
    overflow: hidden;
  }
  thead {
    background: rgba(0,0,0,0.6);
  }
  tbody tr {
    transition: background 0.3s ease;
  }
  tbody tr:hover {
    background: rgba(255,255,255,0.1);
  }

  /* 🎛️ Inputs */
  .qty-input {
    text-align: center;
    border-radius: 8px;
    border: none;
    padding: 5px;
    width: 70px;
  }

  /* 🟢 Boutons stylés */
  .btn {
    border-radius: 12px;
    transition: all 0.3s ease;
  }
  .btn:hover {
    transform: scale(1.05);
  }
  .btn-danger:hover {
    background: #ff4b5c;
  }
  .btn-success {
    background: #25d366;
    border: none;
  }
  .btn-success:hover {
    background: #1ebe57;
  }

  /* 💰 Total général stylé */
  #grand-total {
    font-size: 1.2rem;
    font-weight: bold;
    background: linear-gradient(90deg, #ffdd00, #ff9900);
    -webkit-background-clip: text;
    -webkit-text-fill-color: transparent;
  }
</style>

<div class="container my-5">
  <div class="panier-card">
    <h2 class="text-center mb-4">🛒 Mon Panier</h2>

    {% if panier %}
    <div class="table-responsive">
      <table class="table table-bordered align-middle text-center text-light">
        <thead>
          <tr>
            <th>Produit</th>
            <th>Image</th>
            <th>Prix Unitaire (FCFA)</th>
            <th>Quantité</th>
            <th>Total (FCFA)</th>
            <th>Supprimer</th>
          </tr>
        </thead>
        <tbody>
          {% for key, item in panier.items %}
          <tr data-key="{{ key }}">
            <td class="item-nom">{{ item.nom }}</td>
            <td><img src="{{ item.image }}" alt="{{ item.nom }}" width="60" class="rounded shadow"></td>
            <td class="unit-price">{{ item.prix|floatformat:2 }}</td>
            <td>
              <input type="number" class="form-control form-control-sm qty-input" min="1"
                     value="{{ item.quantite }}" data-key="{{ key }}">
            </td>
            <td class="item-total" data-key="{{ key }}">{{ item.total|floatformat:2 }}</td>
            <td>
              <form method="POST" action="{% url 'supprimer_du_panier' key %}">
                {% csrf_token %}
                <button type="submit" class="btn btn-sm btn-danger">❌</button>
              </form>
            </td>
          </tr>
          {% endfor %}
        </tbody>
      </table>
    </div>


<div class="d-flex flex-column flex-md-row justify-content-md-end align-items-center gap-3 mt-4 text-center text-md-end">
  <h4 class="mb-2 mb-md-0">Total Général : <span id="grand-total">{{ total|floatformat:2 }} FCFA</span></h4>
  
  <div class="d-flex flex-column flex-sm-row gap-2">
    <a href="{% url 'boutique' %}" class="btn btn-secondary">🛍️ Continuer mes achats</a>
    <a id="whatsapp-btn" href="{{ whatsapp_url }}" target="_blank" class="btn btn-success">💬 Commander via WhatsApp</a>
  </div>
</div>

    {% else %}
    <p class="text-center">Votre panier est vide.</p>
    <div class="text-center">
      <a href="{% url 'boutique' %}" class="btn btn-primary">Retour à la boutique</a>
    </div>
    {% endif %}
  </div>
</div>

<script>
(function(){
  // helper pour récupérer csrftoken
  function getCookie(name) {
      let cookieValue = null;
      if (document.cookie && document.cookie !== '') {
          const cookies = document.cookie.split(';');
          for (let i = 0; i < cookies.length; i++) {
              const cookie = cookies[i].trim();
              if (cookie.substring(0, name.length + 1) === (name + '=')) {
                  cookieValue = decodeURIComponent(cookie.substring(name.length + 1));
                  break;
              }
          }
      }
      return cookieValue;
  }
  const csrftoken = getCookie('csrftoken');

  // debounce util
  function debounce(fn, delay){
    let t;
    return function(...args){
      clearTimeout(t);
      t = setTimeout(()=> fn.apply(this, args), delay);
    }
  }

  // envoie modification quantité via fetch POST
  async function updateQuantity(key, quantite){
    const url = "{% url 'modifier_quantite' 'REPLACE_KEY' %}".replace('REPLACE_KEY', key);
    const form = new FormData();
    form.append('quantite', quantite);

    const resp = await fetch(url, {
      method: 'POST',
      headers: {
        'X-Requested-With': 'XMLHttpRequest',
        'X-CSRFToken': csrftoken
      },
      body: form
    });

    if (!resp.ok) {
      console.error('Erreur lors de la mise à jour du panier');
      return null;
    }
    return resp.json();
  }

  // mise à jour du lien WhatsApp dynamiquement
  /*function updateWhatsappLink() {
    let message = "Bonjour, je souhaite commander :\n";
    let grandTotal = 0;

    document.querySelectorAll('tbody tr').forEach(row => {
      const nom = row.querySelector('.item-nom').innerText;
      const qty = parseInt(row.querySelector('.qty-input').value);
      const prix = parseFloat(row.querySelector('.unit-price').innerText);
      const total = prix * qty;
      grandTotal += total;

      message += `- ${nom} (x${qty})\n`;
    });

    message += `\nTotal : ${grandTotal.toFixed(2)} FCFA`;
    const whatsappNumber = "22898700015";
    const whatsappUrl = `https://wa.me/${whatsappNumber}?text=${encodeURIComponent(message)}`;

    const btn = document.getElementById('whatsapp-btn');
    if(btn) btn.href = whatsappUrl;
  } */

  // Attachement événements sur tous les inputs quantity
  document.querySelectorAll('.qty-input').forEach(input => {
    const debounced = debounce(async function(){
      const key = this.dataset.key;
      let q = parseInt(this.value) || 1;
      if (q < 1) q = 1, this.value = 1;

      const data = await updateQuantity(key, q);
      if (data) {
        const itemTotalCell = document.querySelector('.item-total[data-key="'+key+'"]');
        if (itemTotalCell) itemTotalCell.innerText = parseFloat(data.item_total).toFixed(2);

        const grand = document.getElementById('grand-total');
        if (grand) grand.innerText = parseFloat(data.total).toFixed(2) + ' FCFA';

        // 🔄 mettre à jour WhatsApp après chaque changement
        updateWhatsappLink();
      }
    }, 450);

    input.addEventListener('input', debounced);
  });

  // Initialisation au chargement
  updateWhatsappLink();

})();
</script>

{% endblock %}
